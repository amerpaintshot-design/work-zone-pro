<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WorkZoneCalc | Full Site Manager</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root { --safety-orange: #ff8c00; --dark-bg: #1a1a1a; --card-bg: #333; --blue-accent: #007bff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--dark-bg); color: white; text-align: center; padding: 20px; }
        
        .calc-box { background: var(--card-bg); border: 4px solid var(--safety-orange); padding: 30px; border-radius: 15px; display: inline-block; max-width: 1000px; width: 100%; box-shadow: 0 15px 40px rgba(0,0,0,0.6); box-sizing: border-box; }
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; text-align: left; margin-bottom: 20px; }
        label { font-size: 0.7rem; color: var(--safety-orange); font-weight: bold; text-transform: uppercase; }
        
        input { padding: 10px; width: 100%; border-radius: 6px; border: 2px solid #444; font-size: 0.95rem; background: #fff; color: #222; box-sizing: border-box; }
        
        .team-section { background: #222; padding: 20px; border-radius: 10px; margin: 20px 0; border: 1px solid #444; text-align: left; }
        .team-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

        .btn-group { display: flex; gap: 10px; margin: 20px 0; }
        button { flex: 2; background: var(--safety-orange); color: #000; padding: 15px; font-weight: 900; border: none; cursor: pointer; border-radius: 6px; text-transform: uppercase; }
        .btn-pdf { flex: 1; background: #555; color: white; }

        .result-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 25px; border-top: 1px solid #555; padding-top: 20px; text-align: left; }
        .result-card { background: #444; padding: 12px; border-radius: 8px; border-left: 5px solid var(--safety-orange); }
    </style>
</head>
<body onload="initMap()">

    <div class="calc-box">
        <h1>ðŸš§ WorkZoneCalc Pro + Team</h1>
        
        <div class="input-grid">
            <div style="grid-column: span 2;"><label>Project Name</label><input type="text" id="projName" placeholder="Client / Location"></div>
            <div><label>Speed (MPH)</label><input type="number" id="speed" value="45"></div>
            <div><label>Duration (Days)</label><input type="number" id="duration" value="3"></div>
        </div>

        <div class="team-section">
            <label style="display:block; margin-bottom:10px;">Crew & Responsibility</label>
            <div class="team-grid">
                <div><label>Setup Lead</label><input type="text" id="setupLead" placeholder="Name"></div>
                <div><label>Safety Inspector (Daily)</label><input type="text" id="safetyOfficer" placeholder="Name"></div>
                <div><label>Emergency Contact</label><input type="text" id="phone" placeholder="555-0199"></div>
                <div><label>Crew Size</label><input type="number" id="crewSize" value="2"></div>
            </div>
        </div>

        <div id="map" style="height: 200px; border-radius: 8px; margin-bottom: 20px;"></div>
        
        <div class="btn-group">
            <button onclick="calculate()">Finalize Site Plan</button>
            <button class="btn-pdf" id="pdfBtn" style="display:none;" onclick="downloadPDF()">Export Operations PDF</button>
        </div>
        
        <div id="outputUI" class="result-container" style="display:none;">
            <div class="result-card"><h4>Lead</h4><b id="resLead">--</b></div>
            <div class="result-card"><h4>Safety</h4><b id="resSafe">--</b></div>
            <div class="result-card"><h4>Taper</h4><b id="resTaper">0 ft</b></div>
            <div class="result-card"><h4>Total Budget</h4><b id="resTotal">$0.00</b></div>
        </div>
    </div>

    <div id="pdf-report" style="display:none; color: black; padding: 40px; font-family: sans-serif;">
        <h1 style="color: #ff8c00; border-bottom: 3px solid #ff8c00;">Operations & Safety Plan</h1>
        <h3>1. Project Details</h3>
        <p><strong>Name:</strong> <span id="pdf-name"></span> | <strong>Date:</strong> <span id="pdf-date"></span></p>
        
        <h3>2. Personnel Assignments</h3>
        <table style="width: 100%; border-collapse: collapse;">
            <tr style="background: #f2f2f2;">
                <th style="border: 1px solid #ccc; padding: 8px;">Role</th>
                <th style="border: 1px solid #ccc; padding: 8px;">Assigned To</th>
            </tr>
            <tr><td style="border: 1px solid #ccc; padding: 8px;">Setup & Deployment Lead</td><td id="pdf-lead" style="border: 1px solid #ccc; padding: 8px;"></td></tr>
            <tr><td style="border: 1px solid #ccc; padding: 8px;">Daily Safety Inspector</td><td id="pdf-safe" style="border: 1px solid #ccc; padding: 8px;"></td></tr>
            <tr><td style="border: 1px solid #ccc; padding: 8px;">Emergency Hotline</td><td id="pdf-phone" style="border: 1px solid #ccc; padding: 8px;"></td></tr>
        </table>

        <h3>3. Setup Specifications</h3>
        <p><strong>Min Taper:</strong> <span id="pdf-taper"></span> | <strong>Target Speed:</strong> <span id="pdf-speed"></span> MPH</p>
        <p><strong>Estimated Crew Size:</strong> <span id="pdf-crew"></span> members</p>
    </div>

    <script>
        let map, marker, lat, lng;
        let currentData = {};

        function initMap() {
            map = L.map('map').setView([39.82, -98.57], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            map.on('click', e => {
                if(marker) map.removeLayer(marker);
                marker = L.marker(e.latlng).addTo(map);
                lat = e.latlng.lat; lng = e.latlng.lng;
            });
        }

        function calculate() {
            const S = parseFloat(document.getElementById('speed').value);
            const dur = parseFloat(document.getElementById('duration').value);
            
            let L = (S >= 45) ? (12 * S) : (12 * Math.pow(S, 2)) / 60;
            let qty = Math.ceil(L / S) + 20; // Simplified qty estimate
            let grandTotal = (qty * 1.5 * dur) + 250;

            currentData = {
                name: document.getElementById('projName').value || "Unnamed Site",
                lead: document.getElementById('setupLead').value || "Unassigned",
                safe: document.getElementById('safetyOfficer').value || "Unassigned",
                phone: document.getElementById('phone').value || "None Provided",
                crew: document.getElementById('crewSize').value,
                taper: Math.round(L),
                grand: grandTotal.toFixed(2),
                speed: S,
                date: new Date().toLocaleDateString()
            };

            document.getElementById('resLead').innerText = currentData.lead;
            document.getElementById('resSafe').innerText = currentData.safe;
            document.getElementById('resTaper').innerText = currentData.taper + " ft";
            document.getElementById('resTotal').innerText = "$" + currentData.grand;
            
            document.getElementById('outputUI').style.display = "grid";
            document.getElementById('pdfBtn').style.display = "block";
        }

        function downloadPDF() {
            document.getElementById('pdf-name').innerText = currentData.name;
            document.getElementById('pdf-date').innerText = currentData.date;
            document.getElementById('pdf-lead').innerText = currentData.lead;
            document.getElementById('pdf-safe').innerText = currentData.safe;
            document.getElementById('pdf-phone').innerText = currentData.phone;
            document.getElementById('pdf-taper').innerText = currentData.taper + " ft";
            document.getElementById('pdf-speed').innerText = currentData.speed;
            document.getElementById('pdf-crew').innerText = currentData.crew;

            const element = document.getElementById('pdf-report');
            element.style.display = 'block';
            html2pdf().from(element).save().then(() => element.style.display = 'none');
        }
    </script>
</body>
</html>
